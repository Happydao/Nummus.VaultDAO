name: Monitor Vault + Swap Events

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    env:
      HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch balances and transfers
        run: |
          mkdir -p data

          WALLET1="AoXJQjDcK7C28ecdNVQjGjXW8V6nxR7NY7rBFhdhUc5B"
          WALLET2="HtT3yMsAavLQYmd6VSbXSdbAefyZUrrFeEPoTPivde3s"
          MINT_TBTC="6DNSN2BJsaPFdFFc1zP37kkeNe4Usc1Sqkzr9C9vPWcU"

          API="https://mainnet.helius-rpc.com/?api-key=$HELIUS_API_KEY"

          # === 1. TBTC Balance (Vault) ===
          BALANCE_RES=$(curl -s -X POST "$API" -H "Content-Type: application/json" -d '{
            "jsonrpc":"2.0",
            "id":"1",
            "method":"getAssetsByOwner",
            "params":{
              "ownerAddress":"'$WALLET2'",
              "page":1,
              "limit":1000,
              "options":{"showFungible":true,"showZeroBalance":false}
            }
          }')

          VAULT_BAL=$(echo "$BALANCE_RES" | jq -r --arg M "$MINT_TBTC" '
            .result.items[] | select(.id == $M) |
            {bal: (.token_info.balance | tonumber), dec: (.token_info.decimals | tonumber)} |
            "\(.bal) \(.dec)"' | awk '{ printf "%.8f", $1 / (10 ^ $2) }')

          # === 2. Ultime 2 transazioni su wallet 1 (ricezione TBTC) ===
          SWAPS=$(curl -s -X GET "https://api.helius.xyz/v0/addresses/$WALLET1/transfers?api-key=$HELIUS_API_KEY&limit=20")

          SWAP_EVENTS=$(echo "$SWAPS" | jq -c --arg M "$MINT_TBTC" '
            .transfers | map(select(.token.mint == $M and .type == "transfer" and .destination == "$WALLET1"))
            | sort_by(.timestamp) | reverse | .[:2]
            | map({
                tbtc_received: (.token.amount | tostring),
                timestamp: (.timestamp | todateiso8601)
              })
          ')

          # === 3. Ultime 2 transazioni su vault (ricezione TBTC) ===
          VAULT_XFERS=$(curl -s -X GET "https://api.helius.xyz/v0/addresses/$WALLET2/transfers?api-key=$HELIUS_API_KEY&limit=20")

          VAULT_EVENTS=$(echo "$VAULT_XFERS" | jq -c --arg M "$MINT_TBTC" '
            .transfers | map(select(.token.mint == $M and .type == "transfer" and .destination == "$WALLET2"))
            | sort_by(.timestamp) | reverse | .[:2]
            | map({
                amount: (.token.amount | tostring),
                timestamp: (.timestamp | todateiso8601)
              })
          ')

          # === 4. Scrivi JSON finale ===
          cat <<EOF > data/status.json
          {
            "vault_balance": "$VAULT_BAL",
            "vault_last_transfers": $VAULT_EVENTS,
            "swap_events": $SWAP_EVENTS,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit if changed
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git diff --quiet || (git add data/status.json && git commit -m "Update vault and swap info" && git push)
