name: Monitor TBTC Vault

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    env:
      HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq bc curl

      - name: Check TBTC vault balance
        run: |
          mkdir -p data

          API_URL="https://mainnet.helius-rpc.com/?api-key=$HELIUS_API_KEY"
          VAULT="HtT3yMsAavLQYmd6VSbXSdbAefyZUrrFeEPoTPivde3s"
          TBTC_MINT="6DNSN2BJsaPFdFFc1zP37kkeNe4Usc1Sqkzr9C9vPWcU"

          RESPONSE=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc":"2.0",
              "id":"1",
              "method":"getAssetsByOwner",
              "params":{
                "ownerAddress":"'"$VAULT"'",
                "page":1,
                "limit":1000,
                "options":{
                  "showFungible":true,
                  "showZeroBalance":false
                }
              }
            }')

          echo "$RESPONSE" > data/vault_raw.json

          # Estrai balance e decimali, poi calcola divisione con awk
          BALANCE=$(echo "$RESPONSE" | jq -r --arg M "$TBTC_MINT" '
            .result.items[]
            | select(.id == $M)
            | {
                bal: (.token_info.balance | tonumber),
                dec: (.token_info.decimals | tonumber)
              }
            | "\(.bal) \(.dec)"
          ' | awk '{ printf "%.8f\n", $1 / (10 ^ $2) }')

          echo "âœ… Vault TBTC balance: $BALANCE"

          # Scrivi nel file JSON
          cat <<EOF > data/status.json
          {
            "vault_address": "$VAULT",
            "tbtc_balance": "$BALANCE",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit if changed
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git diff --quiet || (git add data/status.json && git commit -m "Update vault balance" && git push)
